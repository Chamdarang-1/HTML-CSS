<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>비밀번호 찾기</title>
    <style>
        :root {
            --black: #111;
            --gray: #777;
            --light: #f4f5f7;
            --primary: #111;
            --accent: #3F97F6
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            margin: 0
        }

        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Pretendard, Apple SD Gothic Neo, Malgun Gothic, Noto Sans KR, sans-serif;
            color: var(--black);
            background: #fff
        }

        .wrap {
            max-width: 760px;
            margin: 48px auto;
            padding: 0 20px
        }

        h1 {
            font-size: 40px;
            letter-spacing: -.02em;
            margin: 0 0 24px;
            text-align: center
        }

        .desc {
            color: #555;
            text-align: center;
            line-height: 1.6;
            margin-bottom: 28px
        }

        .card {
            background: #fff;
            border: 1px solid #e6e6e6;
            padding: 28px 24px
        }

        .row {
            margin-bottom: 18px
        }

        label {
            display: block;
            font-weight: 600;
            margin: 0 0 8px
        }

        .field {
            width: 100%;
            height: 48px;
            padding: 0 14px;
            border: 1px solid #ddd;
            outline: none
        }

        .field:focus {
            border-color: #222;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, .06)
        }

        .helper {
            font-size: 13px;
            color: #888;
            margin-top: 6px
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 24px
        }

        .btn {
            flex: 1 1 0;
            height: 50px;
            border: 1px solid #111;
            background: #111;
            color: #fff;
            font-weight: 700;
            cursor: pointer
        }

        .btn.secondary {
            background: #fff;
            color: #111
        }

        .btn:disabled {
            opacity: .5;
            cursor: not-allowed
        }

        .inline {
            display: flex;
            gap: 10px;
            align-items: center
        }

        .radio-line {
            display: flex;
            gap: 18px;
            align-items: center
        }

        /* ★ 추가 */
        .radio-line .item {
            display: flex;
            gap: 8px;
            align-items: center
        }

        /* ★ 추가 */

        .sub-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px
        }

        .hidden {
            display: none
        }

        .select {
            width: 100%;
            height: 48px;
            border: 1px solid #ddd;
            padding: 0 12px
        }

        .bar {
            height: 1px;
            background: #eee;
            margin: 20px 0
        }

        .row-email {
            margin: 10px 0 18px 0
        }

        .row-phone {
            margin: 10px 0 18px 0
        }

        /* ★ 추가 */

        /* 재설정 섹션 보조 스타일 */
        #strengthBar {
            height: 6px;
            background: #eee;
            margin-top: 8px;
            position: relative;
            border-radius: 3px;
            overflow: hidden
        }

        #strengthFill {
            height: 100%;
            width: 0%
        }

        /* 접근성용 시각적 숨김 */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 1, 1);
            white-space: nowrap;
            border: 0;
        }

        /* 이메일/휴대폰 인증번호 입력 줄: 입력칸 가변 + 버튼 고정 */
        #emailVerifyGroup .inline,
        #phoneVerifyGroup .inline {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: nowrap;
        }

        /* ★ 수정 */

        #emailVerifyGroup .inline .field,
        #phoneVerifyGroup .inline .field {
            flex: 1 1 auto;
            width: auto;
            /* ★ 수정 */
        }

        #emailVerifyGroup .inline .btn,
        #phoneVerifyGroup .inline .btn {
            flex: 0 0 120px;
            width: 120px;
            height: 48px;
            border-radius: 0;
            white-space: nowrap;
            /* ★ 수정 */
        }
    </style>
</head>

<script>
    /* 헤더/푸터 include */
    fetch("../main/header.html")
        .then(res => res.text())
        .then(data => {
            document.getElementById("header").innerHTML = data;
            const scripts = document.getElementById("header").querySelectorAll("script");
            scripts.forEach(oldScript => {
                const s = document.createElement("script");
                if (oldScript.src) { s.src = oldScript.src; } else { s.textContent = oldScript.textContent; }
                document.body.appendChild(s);
            });
        });

    fetch("../main/footer.html")
        .then(res => res.text())
        .then(data => { document.getElementById("footer").innerHTML = data; });
</script>

<body>
    <div id="header"></div>
    <div class="wrap">
        <h1>비밀번호 찾기</h1>
        <p class="desc">이메일 또는 휴대폰 인증으로 비밀번호를 재설정할 수 있습니다.</p>

        <div class="card">
            <!-- ===== (1) 인증 단계 ===== -->
            <section id="verifySection" aria-label="인증 단계">
                <!-- 회원유형 -->
                <div class="row">
                    <label for="memberType">회원유형</label>
                    <select id="memberType" class="select" aria-label="회원유형">
                        <option value="personal">일반회원</option>
                        <option value="business">판매자회원</option>
                    </select>
                </div>

                <!-- 인증 방식 선택 (이메일/휴대폰) ★ 추가 -->
                <div class="row">
                    <label>인증 방식</label>
                    <div class="radio-line" role="radiogroup" aria-label="인증 방식">
                        <label class="item"><input type="radio" name="method" value="email" checked> 이메일</label>
                        <label class="item"><input type="radio" name="method" value="phone"> 휴대폰 인증</label>
                    </div>
                </div>

                <!-- 아이디 입력 -->
                <div class="row">
                    <label for="userid">아이디</label>
                    <input id="userid" class="field" type="text" placeholder="아이디를 입력하세요" autocomplete="username"
                        required>
                </div>

                <div class="bar" aria-hidden="true"></div>

                <!-- 이메일 인증 영역 -->
                <section id="emailSection" aria-label="이메일 인증">
                    <div class="row">
                        <label for="email">이메일로 찾기</label>
                        <input id="email" class="field" type="email" placeholder="example@domain.com"
                            autocomplete="email">
                        <p class="helper">아이디와 이메일이 모두 입력되어야 인증번호를 전송합니다.</p>
                    </div>
                    <div class="sub-actions">
                        <button id="sendEmailCode" class="btn" type="button" disabled>인증번호 전송</button>
                    </div>
                    <div id="emailVerifyGroup" class="row-email hidden">
                        <label class="sr-only" for="emailCode">인증번호</label>
                        <div class="inline">
                            <input id="emailCode" class="field" type="text" inputmode="numeric" pattern="[0-9]*"
                                placeholder="전송받은 인증번호 입력">
                            <button id="verifyEmailCode" class="btn" type="button">확인</button>
                        </div>
                    </div>
                </section>

                <!-- 휴대폰 인증 영역 ★ 추가 -->
                <section id="phoneSection" class="hidden" aria-label="휴대폰 인증">
                    <div class="row">
                        <label for="phone">휴대폰 번호로 찾기</label>
                        <input id="phone" class="field" type="tel" inputmode="tel" placeholder="01012345678"
                            maxlength="11" />
                        <p class="helper">아이디와 휴대폰 번호가 모두 입력되어야 인증번호를 전송합니다. 하이픈 없이 숫자만 입력.</p>
                    </div>
                    <div class="sub-actions">
                        <button id="sendSmsCode" class="btn" type="button" disabled>인증번호 전송</button>
                    </div>
                    <div id="phoneVerifyGroup" class="row-phone hidden">
                        <label class="sr-only" for="smsCode">인증번호</label>
                        <div class="inline">
                            <input id="smsCode" class="field" type="text" inputmode="numeric" pattern="[0-9]*"
                                placeholder="전송받은 인증번호 입력">
                            <button id="verifySmsCode" class="btn" type="button">확인</button>
                        </div>
                    </div>
                </section>

                <div class="actions">
                    <button id="cancelBtn" class="btn secondary" type="button" onclick="location.href='#'">취소</button>
                    <button id="nextBtn" class="btn" type="button" disabled>다음</button>
                </div>
            </section>

            <!-- ===== (2) 비밀번호 재설정 단계 (기존 유지) ===== -->
            <section id="resetSection" class="hidden" aria-label="비밀번호 재설정">
                <div class="bar" aria-hidden="true"></div>

                <form id="resetForm" novalidate>
                    <!-- 아이디 표시 -->
                    <div class="row">
                        <label for="resetUserId">아이디</label>
                        <input id="resetUserId" class="field" type="text" placeholder="아이디" autocomplete="username"
                            required readonly>
                        <p id="uidHelp" class="helper">인증이 완료된 아이디입니다.</p>
                    </div>

                    <!-- 새 비밀번호 -->
                    <div class="row">
                        <label for="newPass">새 비밀번호</label>
                        <div class="inline" style="width:100%">
                            <input id="newPass" class="field" type="password" placeholder="새 비밀번호 입력"
                                autocomplete="new-password" required>
                            <button type="button" id="toggleNewPass" class="btn secondary"
                                style="flex:0 0 auto; width:120px">표시/숨김</button>
                        </div>
                        <p class="helper">8~16자, 공백 없음, 영문/숫자/특수문자 중 2가지 이상 포함</p>
                        <p id="ruleMsg" class="helper" style="color:#c00; display:none"></p>
                        <div id="strengthBar">
                            <div id="strengthFill"></div>
                        </div>
                    </div>

                    <!-- 새 비밀번호 확인 -->
                    <div class="row">
                        <label for="confirmPass">새 비밀번호 확인</label>
                        <div class="inline" style="width:100%">
                            <input id="confirmPass" class="field" type="password" placeholder="새 비밀번호 확인 입력"
                                autocomplete="new-password" required>
                            <button type="button" id="toggleConfirmPass" class="btn secondary"
                                style="flex:0 0 auto; width:120px">표시/숨김</button>
                        </div>
                        <p id="matchMsg" class="helper" style="color:#c00; display:none"></p>
                    </div>

                    <div class="actions">
                        <button type="button" class="btn secondary" id="backToVerify">이전</button>
                        <button id="submitBtn" type="submit" class="btn" disabled>다음</button>
                    </div>
                </form>
            </section>
        </div>

        <p class="helper" style="margin-top:14px"></p>
    </div>

    <script>
        // ===== 공통 선택자 =====
        const $ = (s) => document.querySelector(s);
        const $$ = (s) => Array.from(document.querySelectorAll(s));

        // 섹션
        const verifySection = $('#verifySection');
        const resetSection = $('#resetSection');

        // 상태: 인증 방식 및 인증 결과 (★ 수정)
        const state = { method: 'email', emailCode: null, smsCode: null, emailVerified: false, phoneVerified: false };

        const nextBtn = $('#nextBtn');

        // 섹션 토글 (★ 추가)
        const emailSection = $('#emailSection');
        const phoneSection = $('#phoneSection');
        function toggleSectionsByMethod() {
            if (state.method === 'email') {
                emailSection.classList.remove('hidden');
                phoneSection.classList.add('hidden');
            } else {
                phoneSection.classList.remove('hidden');
                emailSection.classList.add('hidden');
            }
            updateNextAvailability();
            updateSendButtons();
        }

        // 기본 입력 유효성 (★ 수정: 방법별 분기)
        function validateBasic() {
            const idOk = $('#userid').value.trim().length >= 3;

            if (state.method === 'email') {
                const email = $('#email').value.trim();
                const emailOk = /.+@.+\..+/.test(email);
                return idOk && emailOk && state.emailVerified;
            } else {
                const phone = $('#phone').value.trim();
                const phoneOk = /^01[0-9]{8,9}$/.test(phone);
                return idOk && phoneOk && state.phoneVerified;
            }
        }
        function updateNextAvailability() { nextBtn.disabled = !validateBasic(); }

        // 전송 버튼 활성화 로직 (아이디 입력 여부 기반) (★ 수정)
        function updateSendButtons() {
            const idOk = $('#userid').value.trim().length >= 3;
            const emailBtn = $('#sendEmailCode');
            const smsBtn = $('#sendSmsCode');
            if (emailBtn) emailBtn.disabled = !idOk;
            if (smsBtn) smsBtn.disabled = !idOk;
        }

        // 인증 방식 라디오 변경 (★ 추가)
        $$('input[name="method"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                state.method = e.target.value;
                toggleSectionsByMethod();
            });
        });

        // 입력 변화 감지
        ['#userid', '#email', '#phone', '#emailCode', '#smsCode'].forEach(sel => {
            const el = $(sel); if (!el) return;
            el.addEventListener('input', () => { updateNextAvailability(); updateSendButtons(); });
        });

        // 전송(Mock)
        const pseudoSend = () => new Promise(res => setTimeout(res, 600));

        // 이메일 인증번호 전송
        $('#sendEmailCode').addEventListener('click', async () => {
            const uid = $('#userid').value.trim();
            const email = $('#email').value.trim();
            if (uid.length < 3) return alert('아이디를 입력해 주세요.');
            if (!/.+@.+\..+/.test(email)) return alert('이메일 형식을 확인해 주세요.');
            await pseudoSend();
            state.emailCode = String(Math.floor(100000 + Math.random() * 900000));
            console.log('[DEV] email code:', state.emailCode);
            $('#emailVerifyGroup').classList.remove('hidden');
            alert('인증 번호를 전송했습니다!');
        });

        // 이메일 인증번호 확인
        $('#verifyEmailCode').addEventListener('click', () => {
            const input = $('#emailCode').value.trim();
            if (input && input === state.emailCode) {
                state.emailVerified = true;
                alert('이메일 인증 완료');
                updateNextAvailability();
            } else {
                alert('인증번호가 일치하지 않습니다.');
            }
        });

        // SMS 인증번호 전송 (★ 추가)
        $('#sendSmsCode').addEventListener('click', async () => {
            const uid = $('#userid').value.trim();
            const phone = $('#phone').value.trim();
            if (uid.length < 3) return alert('아이디를 입력해 주세요.');
            if (!/^01[0-9]{8,9}$/.test(phone)) return alert('휴대폰 번호를 확인해 주세요.');
            await pseudoSend();
            state.smsCode = String(Math.floor(100000 + Math.random() * 900000));
            console.log('[DEV] sms code:', state.smsCode);
            $('#phoneVerifyGroup').classList.remove('hidden');
            alert('인증 번호를 전송했습니다!');
        });

        // SMS 인증번호 확인 (★ 추가)
        $('#verifySmsCode').addEventListener('click', () => {
            const input = $('#smsCode').value.trim();
            if (input && input === state.smsCode) {
                state.phoneVerified = true;
                alert('휴대폰 인증 완료');
                updateNextAvailability();
            } else {
                alert('인증번호가 일치하지 않습니다.');
            }
        });

        // ===== 다음: 재설정 섹션 열기 (기존 로직 유지) =====
        nextBtn.addEventListener('click', () => {
            if (!validateBasic()) { alert('인증을 완료해 주세요.'); return; }

            // 인증된 아이디 전달
            const verifiedUid = $('#userid').value.trim();
            sessionStorage.setItem('verifiedUserId', verifiedUid);

            // 화면 전환
            verifySection.classList.add('hidden');
            resetSection.classList.remove('hidden');

            // 아이디 채워넣기
            const u = sessionStorage.getItem('verifiedUserId');
            const resetUserId = document.getElementById('resetUserId');
            resetUserId.value = u || verifiedUid;
            resetUserId.readOnly = !!(u || verifiedUid);

            document.getElementById('newPass').focus();
            resetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });

        // ===== 재설정 섹션 로직 (기존) =====
        const resetUserId = $('#resetUserId');
        const newPassInput = $('#newPass');
        const confirmInput = $('#confirmPass');
        const submitBtn = $('#submitBtn');
        const ruleMsg = $('#ruleMsg');
        const matchMsg = $('#matchMsg');
        const strengthFill = $('#strengthFill');

        function passRuleOK(pw) {
            if (!pw) return false;
            if (pw.length < 8 || pw.length > 16) return false;
            if (/\s/.test(pw)) return false;
            const hasAlpha = /[A-Za-z]/.test(pw);
            const hasNum = /[0-9]/.test(pw);
            const hasSpec = /[~`!@#$%^*()\-_=+\[\]{};:'",.<>/?\\|]/.test(pw);
            return [hasAlpha, hasNum, hasSpec].filter(Boolean).length >= 2;
        }
        function strengthScore(pw) {
            let s = 0; if (!pw) return 0;
            if (/[A-Za-z]/.test(pw)) s++;
            if (/[0-9]/.test(pw)) s++;
            if (/[~`!@#$%^*()\-_=+\[\]{};:'",.<>/?\\|]/.test(pw)) s++;
            if (pw.length >= 12) s++;
            return Math.min(s, 3);
        }
        function paintStrength(pw) {
            const score = strengthScore(pw);
            const widths = ['0%', '33%', '66%', '100%'];
            const colors = ['transparent', '#f5b7b1', '#f7dc6f', '#a9dfbf'];
            strengthFill.style.width = widths[score];
            strengthFill.style.background = colors[score];
        }
        function validateReset() {
            const uidOk = resetUserId.value.trim().length >= 3;
            const ruleOk = passRuleOK(newPassInput.value);
            const matchOk = newPassInput.value && newPassInput.value === confirmInput.value;

            ruleMsg.style.display = ruleOk ? 'none' : 'block';
            ruleMsg.textContent = ruleOk ? '' : '규칙을 확인해 주세요 (8~16자, 공백없음, 2종 이상 조합).';
            matchMsg.style.display = matchOk ? 'none' : 'block';
            matchMsg.textContent = matchOk ? '' : '비밀번호가 일치하지 않습니다.';

            submitBtn.disabled = !(uidOk && ruleOk && matchOk);
        }

        [resetUserId, newPassInput, confirmInput].forEach(el => {
            el.addEventListener('input', () => { paintStrength(newPassInput.value); validateReset(); });
        });

        $('#toggleNewPass').addEventListener('click', () => {
            newPassInput.type = newPassInput.type === 'password' ? 'text' : 'password';
        });
        $('#toggleConfirmPass').addEventListener('click', () => {
            confirmInput.type = confirmInput.type === 'password' ? 'text' : 'password';
        });

        // 이전(재인증으로 돌아가기)
        $('#backToVerify').addEventListener('click', () => {
            resetSection.classList.add('hidden');
            verifySection.classList.remove('hidden');
            $('#userid').focus();
        });

        // 제출 = DB 업데이트 호출 지점
        $('#resetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (submitBtn.disabled) return;

            const payload = {
                userid: resetUserId.value.trim(),
                newPassword: newPassInput.value
            };

            // 실제 연동 예시:
            // const res = await fetch('/api/account/reset-password/complete', {
            //   method:'POST',
            //   headers:{'Content-Type':'application/json'},
            //   body: JSON.stringify(payload)
            // });
            // const data = await res.json();
            // if (data?.ok) location.href = '/account/reset-password/done';
            // else alert(data?.message || '처리 중 오류가 발생했습니다.');

            // 데모
            alert('비밀번호가 변경되었습니다.');
            location.href = '/account/reset-password/done';
        });

        // 초기
        toggleSectionsByMethod();     // ★ 추가: 라디오 초기화 반영
        updateSendButtons();
        updateNextAvailability();
        paintStrength('');
        validateReset();
    </script>

    <div id="footer"></div>
</body>

</html>